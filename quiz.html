<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>在线测验</title>

<style>
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  max-width:720px;margin:auto;padding:18px;line-height:1.5;
  background:#f9fafb;
}

.card{
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:18px;
  margin-bottom:16px;
  background:#fff;
}

.muted{color:#6b7280;font-size:12px}
h2,h3{margin:8px 0}

/* 选项按钮（字体小1号） */
button.opt{
  display:block;
  width:100%;
  margin:10px 0;
  padding:14px;
  border-radius:14px;
  border:1px solid #d1d5db;
  background:#fff;
  font-size:19px; /* 比之前小一号 */
  line-height:1.35;
  cursor:pointer;
  transition:all 0.15s ease;
}

button.opt:hover{
  background:#f3f4f6;
}

button.opt:active{
  transform:scale(0.97);
}

button.opt:disabled{
  opacity:.65;
  cursor:not-allowed;
}

/* 下一题 —— 绿色立体按钮 */
#next{
  display:block;
  width:100%;
  margin:12px 0 0;
  padding:15px;
  border-radius:16px;
  border:none;
  background:#16a34a;
  color:#fff;
  font-size:18px;
  font-weight:900;
  box-shadow:0 6px 14px rgba(22,163,74,0.35);
  cursor:pointer;
  transition:all 0.15s ease;
}

#next:hover{
  background:#15803d;
}

#next:active{
  transform:scale(0.97);
}

/* 提前交卷 —— 柔和红色 */
#submitEarly{
  display:block;
  width:100%;
  margin:12px 0 0;
  padding:15px;
  border-radius:16px;
  border:none;
  background:#fca5a5;
  color:#7f1d1d;
  font-size:18px;
  font-weight:900;
  box-shadow:0 6px 14px rgba(252,165,165,0.4);
  cursor:pointer;
  transition:all 0.15s ease;
}

#submitEarly:hover{
  background:#f87171;
  color:#fff;
}

#submitEarly:active{
  transform:scale(0.97);
}

/* 再做一遍 */
#retryBtn{
  display:block;
  width:100%;
  margin:14px 0 0;
  padding:15px;
  border-radius:16px;
  border:none;
  background:#111827;
  color:#fff;
  font-size:18px;
  font-weight:900;
  cursor:pointer;
}

.ok{color:#16a34a;font-weight:900}
.bad{color:#dc2626;font-weight:900}
.answerLine{margin-top:6px;font-size:16px}
.explainLine{margin-top:6px;font-size:16px}
</style>
</head>

<body>

<div class="card">
  <div class="muted">题库：</div>
  <h3 id="title">加载中...</h3>
</div>

<div id="quiz" style="display:none" class="card">
  <div class="muted">第 <span id="index"></span> / <span id="total"></span> 题</div>
  <h3 id="question"></h3>
  <div id="options"></div>

  <div id="feedback" style="margin-top:10px"></div>

  <button id="next" disabled>下一题</button>
  <button id="submitEarly">提前交卷</button>
</div>

<div id="done" style="display:none" class="card">
  <h2>完成！</h2>
  <div style="font-size:18px;font-weight:900">总分：<span id="score"></span></div>
  <div id="resultMsg" style="margin-top:10px;font-size:18px;font-weight:900"></div>
  <button id="retryBtn" style="display:none">再做一遍</button>
  <div class="muted" style="margin-top:10px">成绩只显示在你的设备上，不会提交给老师。</div>
</div>

<script>
const params=new URLSearchParams(location.search);
const set=params.get("set")||"demo";
const file=`./content/quizzes/${set}.txt`;

let questions=[];
let totalCount=0;
let current=0;
let correctCount=0;
let locked=false;

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function extractFrontmatter(text){
  const t=text.trimStart();
  if(!t.startsWith("---")) return {title:"",bodyText:text};
  const end=t.indexOf("\n---",3);
  if(end===-1) return {title:"",bodyText:text};
  const fm=t.slice(3,end).trim();
  const after=t.indexOf("\n",end+4);
  const body=after===-1?"":t.slice(after+1);

  let title="";
  fm.split("\n").forEach(line=>{
    const m=line.match(/^title:\s*(.*)$/i);
    if(m) title=m[1].replace(/^["']|["']$/g,"").trim();
  });

  return {title,bodyText:body};
}

function parse(text){
  const {title,bodyText}=extractFrontmatter(text);
  const blocks=bodyText.split("\n---\n").map(x=>x.trim()).filter(Boolean);

  const parsed=blocks.map(b=>{
    const lines=b.split("\n").map(x=>x.trim()).filter(Boolean);
    let q="",opts=[],ans="",exp="";
    lines.forEach(l=>{
      if(l.startsWith("Q:")) q=l.slice(2).trim();
      else if(/^[A-Z]\./.test(l)) opts.push(l);
      else if(l.toLowerCase().startsWith("answer:")) ans=l.split(":")[1].trim().toUpperCase();
      else if(l.toLowerCase().startsWith("explain:")) exp=l.split(":")[1]?.trim()||"";
    });
    return {q,opts,ans,exp};
  }).filter(x=>x.q&&x.opts.length>=2&&x.ans);

  shuffle(parsed);
  return {title,questions:parsed};
}

function render(){
  locked=false;
  document.getElementById("feedback").innerHTML="";
  document.getElementById("next").disabled=true;

  const item=questions[current];
  document.getElementById("index").innerText=current+1;
  document.getElementById("total").innerText=totalCount;
  document.getElementById("question").innerText=item.q;

  const opts=shuffle([...item.opts]);
  const optDiv=document.getElementById("options");
  optDiv.innerHTML="";
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="opt";
    b.innerText=o;
    b.onclick=()=>choose(o);
    optDiv.appendChild(b);
  });
}

function choose(opt){
  if(locked) return;
  locked=true;
  const item=questions[current];
  const pick=opt[0].toUpperCase();
  const ok=pick===item.ans;
  if(ok) correctCount++;

  [...document.querySelectorAll("#options button")].forEach(b=>b.disabled=true);

  document.getElementById("feedback").innerHTML=
    (ok
      ?"<div class='ok' style='font-size:24px'>✅ 正确</div>"
      :"<div class='bad' style='font-size:24px'>❌ 错误</div>"
    )+
    `<div class='answerLine'>正确答案：${item.ans}</div>`+
    (item.exp?`<div class='explainLine'>解析：${item.exp}</div>`:"");

  document.getElementById("next").disabled=false;
}

function finishQuiz(){
  document.getElementById("quiz").style.display="none";
  document.getElementById("done").style.display="block";

  const percent=Math.round((correctCount/totalCount)*100);
  document.getElementById("score").innerText=`${percent} / 100`;

  const msg=document.getElementById("resultMsg");
  const retry=document.getElementById("retryBtn");

  if(percent<80){
    msg.innerText="❌ 考试不合格，请重做";
    msg.style.color="#dc2626";
    retry.style.display="block";
  }else{
    msg.innerText="✅ 考试合格";
    msg.style.color="#16a34a";
    retry.style.display="none";
  }
}

document.getElementById("next").onclick=()=>{
  if(current<questions.length-1){
    current++;
    render();
  }else{
    finishQuiz();
  }
};

document.getElementById("submitEarly").onclick=()=>{
  finishQuiz();
};

document.getElementById("retryBtn").onclick=()=>{
  location.reload();
};

fetch(file,{cache:"no-store"})
.then(r=>r.text())
.then(t=>{
  const parsed=parse(t);
  questions=parsed.questions;
  totalCount=questions.length;
  const displayTitle=parsed.title?parsed.title:set;
  document.getElementById("title").innerText=displayTitle;
  document.getElementById("quiz").style.display="block";
  render();
});
</script>

</body>
</html>
