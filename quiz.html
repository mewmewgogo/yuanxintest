<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>在线测验</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Microsoft YaHei",sans-serif;
  max-width:720px;
  margin:auto;
  padding:18px;
  line-height:1.5;
  background:#0f1117;
  color:#e8eaf0;
}

.card{
  border:1px solid #2a3050;
  border-radius:16px;
  padding:20px;
  margin-bottom:16px;
  background:#181c27;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}

.muted{
  color:#8892b0;
  font-size:12px;
}

h2,h3{
  margin:8px 0;
  color:#e8eaf0;
}

/* 选项按钮 */
button.opt{
  display:block;
  width:100%;
  margin:10px 0;
  padding:16px;
  border-radius:12px;
  border:1.5px solid #2a3050;
  background:#1e2436;
  color:#e8eaf0;
  font-size:17px;
  line-height:1.4;
  cursor:pointer;
  transition:all 0.2s ease;
  text-align:left;
}

button.opt:hover{
  border-color:#4f8ef7;
  background:rgba(79,142,247,0.1);
  transform:translateX(3px);
}

button.opt:active{
  transform:scale(0.98);
}

button.opt:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

/* 下一题 - 蓝色立体按钮 */
#next{
  display:block;
  width:100%;
  margin:16px 0 0;
  padding:16px;
  border-radius:12px;
  border:none;
  background:#4f8ef7;
  color:#fff;
  font-size:17px;
  font-weight:700;
  box-shadow:0 6px 16px rgba(79,142,247,0.4);
  cursor:pointer;
  transition:all 0.2s ease;
  letter-spacing:0.5px;
}

#next:hover{
  background:#3b7de8;
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(79,142,247,0.5);
}

#next:active{
  transform:translateY(0);
}

#next:disabled{
  background:#2a3050;
  color:#4a5580;
  cursor:not-allowed;
  box-shadow:none;
}

/* 提前交卷 - 柔和红色 */
#submitEarly{
  display:block;
  width:100%;
  margin:12px 0 0;
  padding:14px;
  border-radius:12px;
  border:1px solid #2a3050;
  background:transparent;
  color:#8892b0;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.2s ease;
}

#submitEarly:hover{
  border-color:#f87171;
  color:#f87171;
  background:rgba(248,113,113,0.08);
}

#submitEarly:active{
  transform:scale(0.98);
}

/* 再做一遍 */
#retryBtn{
  display:block;
  width:100%;
  margin:20px 0 0;
  padding:16px;
  border-radius:12px;
  border:none;
  background:#4f8ef7;
  color:#fff;
  font-size:17px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(79,142,247,0.4);
  transition:all 0.2s ease;
}

#retryBtn:hover{
  background:#3b7de8;
  transform:translateY(-2px);
}

#retryBtn:active{
  transform:translateY(0);
}

.ok{
  color:#34d399;
  font-weight:700;
  font-size:20px;
}

.bad{
  color:#f87171;
  font-weight:700;
  font-size:20px;
}

.answerLine{
  margin-top:8px;
  font-size:15px;
  color:#8892b0;
  padding:10px 14px;
  background:rgba(79,142,247,0.08);
  border-radius:8px;
  border-left:3px solid #4f8ef7;
}

.explainLine{
  margin-top:8px;
  font-size:14px;
  color:#8892b0;
  padding:10px 14px;
  background:rgba(138,146,176,0.05);
  border-radius:8px;
  line-height:1.6;
}

/* 成绩显示 */
#done .card{
  text-align:center;
}

#done h2{
  font-size:24px;
  margin-bottom:20px;
  color:#e8eaf0;
}

#score{
  font-size:48px;
  font-weight:900;
  background:linear-gradient(135deg,#4f8ef7,#34d399);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}

#resultMsg{
  margin-top:16px;
  font-size:20px;
  font-weight:700;
  padding:12px;
  border-radius:8px;
}
</style>
</head>

<body>

<div class="card">
  <div class="muted">题库：</div>
  <h3 id="title">加载中...</h3>
</div>

<div id="quiz" style="display:none" class="card">
  <div class="muted">第 <span id="index"></span> / <span id="total"></span> 题</div>
  <h3 id="question"></h3>
  <div id="options"></div>

  <div id="feedback" style="margin-top:10px"></div>

  <button id="next" disabled>下一题</button>
  <button id="submitEarly">提前交卷</button>
</div>

<div id="done" style="display:none" class="card">
  <h2>完成！</h2>
  <div style="font-size:18px;font-weight:700;margin-bottom:12px">总分：<span id="score"></span></div>
  <div id="resultMsg"></div>
  <button id="retryBtn" style="display:none">再做一遍</button>
  <div class="muted" style="margin-top:16px">成绩只显示在你的设备上，不会提交给老师。</div>
</div>

<script>
const params=new URLSearchParams(location.search);
const set=params.get("set")||"demo";
const file=`./content/quizzes/${set}.txt`;

let questions=[];
let totalCount=0;
let current=0;
let correctCount=0;
let locked=false;

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}

function extractFrontmatter(text){
  const t=text.trimStart();
  if(!t.startsWith("---")) return {title:"",bodyText:text};
  const end=t.indexOf("\n---",3);
  if(end===-1) return {title:"",bodyText:text};
  const fm=t.slice(3,end).trim();
  const after=t.indexOf("\n",end+4);
  const body=after===-1?"":t.slice(after+1);

  let title="";
  fm.split("\n").forEach(line=>{
    const m=line.match(/^title:\s*(.*)$/i);
    if(m) title=m[1].replace(/^["']|["']$/g,"").trim();
  });

  return {title,bodyText:body};
}

function parse(text){
  const {title,bodyText}=extractFrontmatter(text);
  const blocks=bodyText.split("\n---\n").map(x=>x.trim()).filter(Boolean);

  const parsed=blocks.map(b=>{
    const lines=b.split("\n").map(x=>x.trim()).filter(Boolean);
    let q="",opts=[],ans="",exp="";
    lines.forEach(l=>{
      if(l.startsWith("Q:")) q=l.slice(2).trim();
      else if(/^[A-Z]\./.test(l)) opts.push(l);
      else if(l.toLowerCase().startsWith("answer:")) ans=l.split(":")[1].trim().toUpperCase();
      else if(l.toLowerCase().startsWith("explain:")) exp=l.split(":")[1]?.trim()||"";
    });
    return {q,opts,ans,exp};
  }).filter(x=>x.q&&x.opts.length>=2&&x.ans);

  shuffle(parsed);
  return {title,questions:parsed};
}

function render(){
  locked=false;
  document.getElementById("feedback").innerHTML="";
  document.getElementById("next").disabled=true;

  const item=questions[current];
  document.getElementById("index").innerText=current+1;
  document.getElementById("total").innerText=totalCount;
  document.getElementById("question").innerText=item.q;

  const opts=shuffle([...item.opts]);
  const optDiv=document.getElementById("options");
  optDiv.innerHTML="";
  opts.forEach(o=>{
    const b=document.createElement("button");
    b.className="opt";
    b.innerText=o;
    b.onclick=()=>choose(o);
    optDiv.appendChild(b);
  });
}

function choose(opt){
  if(locked) return;
  locked=true;
  const item=questions[current];
  const pick=opt[0].toUpperCase();
  const ok=pick===item.ans;
  if(ok) correctCount++;

  [...document.querySelectorAll("#options button")].forEach(b=>b.disabled=true);

  document.getElementById("feedback").innerHTML=
    (ok
      ?"<div class='ok'>✅ 正确</div>"
      :"<div class='bad'>❌ 错误</div>"
    )+
    `<div class='answerLine'>正确答案：${item.ans}</div>`+
    (item.exp?`<div class='explainLine'>解析：${item.exp}</div>`:"");

  document.getElementById("next").disabled=false;
}

function finishQuiz(){
  document.getElementById("quiz").style.display="none";
  document.getElementById("done").style.display="block";

  const percent=Math.round((correctCount/totalCount)*100);
  document.getElementById("score").innerText=`${percent}`;

  const msg=document.getElementById("resultMsg");
  const retry=document.getElementById("retryBtn");

  if(percent<80){
    msg.innerText="❌ 考试不合格，请重做";
    msg.style.color="#f87171";
    msg.style.background="rgba(248,113,113,0.1)";
    retry.style.display="block";
  }else{
    msg.innerText="✅ 考试合格";
    msg.style.color="#34d399";
    msg.style.background="rgba(52,211,153,0.1)";
    retry.style.display="none";
  }
}

document.getElementById("next").onclick=()=>{
  if(current<questions.length-1){
    current++;
    render();
  }else{
    finishQuiz();
  }
};

document.getElementById("submitEarly").onclick=()=>{
  finishQuiz();
};

document.getElementById("retryBtn").onclick=()=>{
  location.reload();
};

fetch(file,{cache:"no-store"})
.then(r=>r.text())
.then(t=>{
  const parsed=parse(t);
  questions=parsed.questions;
  totalCount=questions.length;
  const displayTitle=parsed.title?parsed.title:set;
  document.getElementById("title").innerText=displayTitle;
  document.getElementById("quiz").style.display="block";
  render();
});
</script>

</body>
</html>
