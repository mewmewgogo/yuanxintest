<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è¯¾å ‚ç­”é¢˜ç³»ç»Ÿ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500&display=swap');

  :root {
    --ink: #1a1a2e;
    --ink-light: #3d3d5c;
    --paper: #f5f0e8;
    --paper-dark: #ede8d8;
    --accent: #c0392b;
    --accent-light: #e74c3c;
    --gold: #c9a84c;
    --correct: #27ae60;
    --wrong: #c0392b;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Noto Sans SC', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  /* Texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(0,0,0,0.03) 28px, rgba(0,0,0,0.03) 29px),
      repeating-linear-gradient(90deg, transparent, transparent 28px, rgba(0,0,0,0.02) 28px, rgba(0,0,0,0.02) 29px);
    pointer-events: none;
    z-index: 0;
  }

  /* Red binding line on left */
  body::after {
    content: '';
    position: fixed;
    left: 72px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(192, 57, 43, 0.25);
    pointer-events: none;
    z-index: 1;
  }

  .wrapper {
    position: relative;
    z-index: 2;
    max-width: 820px;
    margin: 0 auto;
    padding: 40px 24px 80px 100px;
  }

  /* â”€â”€â”€ HEADER â”€â”€â”€ */
  .header {
    display: flex;
    align-items: baseline;
    gap: 16px;
    margin-bottom: 48px;
    border-bottom: 3px double var(--gold);
    padding-bottom: 20px;
  }

  .header h1 {
    font-family: 'Noto Serif SC', serif;
    font-size: 2rem;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 4px;
  }

  .header .sub {
    font-size: 0.85rem;
    color: var(--ink-light);
    letter-spacing: 2px;
  }

  /* â”€â”€â”€ UPLOAD SCREEN â”€â”€â”€ */
  #upload-screen {
    animation: fadeIn 0.5s ease;
  }

  .upload-zone {
    border: 2px dashed var(--gold);
    border-radius: var(--radius);
    background: rgba(201, 168, 76, 0.06);
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    position: relative;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    background: rgba(201, 168, 76, 0.14);
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  }

  .upload-zone input[type=file] {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
    width: 100%;
    height: 100%;
  }

  .upload-icon {
    font-size: 3rem;
    margin-bottom: 16px;
    display: block;
  }

  .upload-zone h2 {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.3rem;
    margin-bottom: 8px;
    color: var(--ink);
  }

  .upload-zone p {
    color: var(--ink-light);
    font-size: 0.9rem;
    line-height: 1.7;
  }

  .format-guide {
    margin-top: 36px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--paper-dark);
    padding: 28px;
  }

  .format-guide h3 {
    font-family: 'Noto Serif SC', serif;
    font-size: 1rem;
    margin-bottom: 16px;
    color: var(--ink);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .format-guide pre {
    background: var(--paper);
    border-radius: 8px;
    padding: 16px;
    font-size: 0.8rem;
    color: var(--ink-light);
    line-height: 1.8;
    white-space: pre-wrap;
    font-family: 'Noto Sans SC', sans-serif;
    border-left: 3px solid var(--gold);
  }

  .format-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .format-tab {
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 0.78rem;
    cursor: pointer;
    border: 1px solid var(--paper-dark);
    background: var(--paper);
    color: var(--ink-light);
    transition: all 0.2s;
  }

  .format-tab.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  /* â”€â”€â”€ PARSING STATE â”€â”€â”€ */
  #parse-screen {
    text-align: center;
    padding: 80px 0;
    animation: fadeIn 0.4s ease;
  }

  .spinner {
    width: 48px; height: 48px;
    border: 3px solid var(--paper-dark);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 24px;
  }

  /* â”€â”€â”€ QUIZ SETUP â”€â”€â”€ */
  #setup-screen {
    animation: fadeIn 0.4s ease;
  }

  .parsed-info {
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--paper-dark);
    padding: 24px;
    margin-bottom: 28px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .parsed-info .icon {
    font-size: 2rem;
    flex-shrink: 0;
  }

  .parsed-info strong {
    display: block;
    font-family: 'Noto Serif SC', serif;
    font-size: 1.1rem;
    margin-bottom: 4px;
  }

  .parsed-info span {
    font-size: 0.85rem;
    color: var(--ink-light);
  }

  .setup-form {
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--paper-dark);
    padding: 32px;
  }

  .setup-form h2 {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.2rem;
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--paper-dark);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--ink-light);
    letter-spacing: 1px;
  }

  .form-group input, .form-group select {
    padding: 10px 14px;
    border: 1px solid var(--paper-dark);
    border-radius: 8px;
    font-size: 0.95rem;
    font-family: 'Noto Sans SC', sans-serif;
    background: var(--paper);
    color: var(--ink);
    transition: border-color 0.2s;
    outline: none;
  }

  .form-group input:focus, .form-group select:focus {
    border-color: var(--gold);
    background: white;
  }

  .type-toggles {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .type-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 20px;
    border: 1px solid var(--paper-dark);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
    user-select: none;
  }

  .type-toggle input { display: none; }
  .type-toggle.checked {
    background: var(--ink);
    color: white;
    border-color: var(--ink);
  }

  .btn-start {
    width: 100%;
    margin-top: 28px;
    padding: 16px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-family: 'Noto Serif SC', serif;
    font-size: 1.1rem;
    letter-spacing: 4px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-start:hover {
    background: var(--accent-light);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(192,57,43,0.3);
  }

  .btn-start:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  /* â”€â”€â”€ QUIZ SCREEN â”€â”€â”€ */
  #quiz-screen {
    animation: fadeIn 0.4s ease;
  }

  .quiz-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }

  .progress-bar-wrap {
    flex: 1;
    height: 6px;
    background: var(--paper-dark);
    border-radius: 99px;
    min-width: 120px;
  }

  .progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 99px;
    transition: width 0.5s ease;
  }

  .q-counter {
    font-size: 0.85rem;
    color: var(--ink-light);
    white-space: nowrap;
  }

  .score-badge {
    font-size: 0.85rem;
    font-weight: 500;
    padding: 4px 12px;
    background: rgba(39,174,96,0.1);
    color: var(--correct);
    border-radius: 20px;
    border: 1px solid rgba(39,174,96,0.25);
  }

  .q-card {
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--paper-dark);
    padding: 36px;
    margin-bottom: 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.04);
    animation: slideUp 0.35s ease;
  }

  .q-type-tag {
    display: inline-block;
    font-size: 0.72rem;
    padding: 3px 10px;
    border-radius: 4px;
    margin-bottom: 16px;
    letter-spacing: 1px;
    font-weight: 500;
  }

  .tag-single { background: rgba(192,57,43,0.1); color: var(--accent); }
  .tag-multi  { background: rgba(41,128,185,0.1); color: #2980b9; }
  .tag-judge  { background: rgba(39,174,96,0.1); color: var(--correct); }
  .tag-fill   { background: rgba(201,168,76,0.1); color: #8b6914; }
  .tag-short  { background: rgba(155,89,182,0.1); color: #8e44ad; }

  .q-text {
    font-family: 'Noto Serif SC', serif;
    font-size: 1.15rem;
    line-height: 1.9;
    color: var(--ink);
    margin-bottom: 28px;
  }

  .q-num {
    color: var(--accent);
    font-weight: 700;
    margin-right: 6px;
  }

  /* Options */
  .options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .option {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    padding: 14px 18px;
    border-radius: 10px;
    border: 1.5px solid var(--paper-dark);
    cursor: pointer;
    transition: all 0.2s;
    background: var(--paper);
    user-select: none;
  }

  .option:hover:not(.disabled) {
    border-color: var(--gold);
    background: white;
    transform: translateX(4px);
  }

  .option.selected {
    border-color: var(--ink);
    background: white;
  }

  .option.correct-ans {
    border-color: var(--correct);
    background: rgba(39,174,96,0.07);
  }

  .option.wrong-ans {
    border-color: var(--wrong);
    background: rgba(192,57,43,0.07);
  }

  .option.disabled { cursor: default; }

  .opt-letter {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 1.5px solid currentColor;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    flex-shrink: 0;
    color: var(--ink-light);
    transition: all 0.2s;
  }

  .option.selected .opt-letter { background: var(--ink); color: white; border-color: var(--ink); }
  .option.correct-ans .opt-letter { background: var(--correct); color: white; border-color: var(--correct); }
  .option.wrong-ans .opt-letter { background: var(--wrong); color: white; border-color: var(--wrong); }

  .opt-text {
    font-size: 0.95rem;
    line-height: 1.7;
    padding-top: 3px;
  }

  /* Fill / short answer */
  .answer-input {
    width: 100%;
    padding: 14px 18px;
    border: 1.5px solid var(--paper-dark);
    border-radius: 10px;
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.95rem;
    line-height: 1.7;
    color: var(--ink);
    background: var(--paper);
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }

  .answer-input:focus { border-color: var(--gold); background: white; }
  .answer-input:disabled { opacity: 0.75; cursor: default; }

  /* Judge */
  .judge-options {
    display: flex;
    gap: 16px;
  }

  .judge-btn {
    flex: 1;
    padding: 16px;
    border-radius: 10px;
    border: 1.5px solid var(--paper-dark);
    background: var(--paper);
    cursor: pointer;
    font-size: 1.1rem;
    font-family: 'Noto Sans SC', sans-serif;
    transition: all 0.2s;
    display: flex; flex-direction: column; align-items: center; gap: 6px;
  }

  .judge-btn span { font-size: 0.85rem; color: var(--ink-light); }
  .judge-btn:hover:not(.disabled) { border-color: var(--gold); background: white; transform: translateY(-2px); }
  .judge-btn.selected { border-color: var(--ink); background: var(--ink); color: white; }
  .judge-btn.selected span { color: rgba(255,255,255,0.7); }
  .judge-btn.correct-ans { border-color: var(--correct); background: rgba(39,174,96,0.1); }
  .judge-btn.wrong-ans { border-color: var(--wrong); background: rgba(192,57,43,0.1); }
  .judge-btn.disabled { cursor: default; }

  /* â”€â”€â”€ RESULT BOX â”€â”€â”€ */
  .result-box {
    border-radius: var(--radius);
    padding: 24px 28px;
    margin-top: 0;
    animation: fadeIn 0.4s ease;
    border: 1px solid;
  }

  .result-box.correct {
    background: rgba(39,174,96,0.07);
    border-color: rgba(39,174,96,0.3);
  }

  .result-box.wrong {
    background: rgba(192,57,43,0.06);
    border-color: rgba(192,57,43,0.25);
  }

  .result-verdict {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 1.05rem;
    margin-bottom: 12px;
  }

  .result-verdict .v-icon { font-size: 1.4rem; }
  .result-box.correct .result-verdict { color: var(--correct); }
  .result-box.wrong .result-verdict { color: var(--wrong); }

  .result-answer {
    font-size: 0.9rem;
    color: var(--ink-light);
    line-height: 1.7;
  }

  .result-answer strong {
    color: var(--ink);
    display: block;
    margin-bottom: 4px;
  }

  .result-explanation {
    margin-top: 14px;
    padding-top: 14px;
    border-top: 1px dashed rgba(0,0,0,0.12);
    font-size: 0.88rem;
    color: var(--ink-light);
    line-height: 1.8;
  }

  .result-explanation strong {
    font-family: 'Noto Serif SC', serif;
    color: var(--ink);
    display: block;
    margin-bottom: 4px;
    font-size: 0.9rem;
  }

  /* Action buttons */
  .q-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }

  .btn {
    padding: 12px 24px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
    letter-spacing: 1px;
  }

  .btn-primary {
    background: var(--ink);
    color: white;
    flex: 1;
  }
  .btn-primary:hover { background: var(--accent); transform: translateY(-1px); }
  .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }

  .btn-secondary {
    background: var(--paper-dark);
    color: var(--ink);
    border: 1px solid var(--paper-dark);
  }
  .btn-secondary:hover { background: white; border-color: var(--ink-light); }

  .btn-skip {
    background: transparent;
    color: var(--ink-light);
    border: 1px solid var(--paper-dark);
    font-size: 0.82rem;
    padding: 10px 18px;
  }
  .btn-skip:hover { border-color: var(--ink-light); color: var(--ink); }

  /* â”€â”€â”€ RESULT SCREEN â”€â”€â”€ */
  #result-screen {
    animation: fadeIn 0.5s ease;
    text-align: center;
  }

  .result-hero {
    padding: 48px 32px;
    background: white;
    border-radius: var(--radius);
    border: 1px solid var(--paper-dark);
    margin-bottom: 28px;
  }

  .result-grade {
    font-family: 'Noto Serif SC', serif;
    font-size: 5rem;
    line-height: 1;
    color: var(--accent);
    margin-bottom: 16px;
    font-weight: 700;
  }

  .result-grade.pass { color: var(--correct); }

  .result-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-top: 28px;
  }

  .stat { text-align: center; }
  .stat-num { font-size: 2rem; font-weight: 700; font-family: 'Noto Serif SC', serif; }
  .stat-label { font-size: 0.8rem; color: var(--ink-light); margin-top: 4px; letter-spacing: 1px; }

  .review-list {
    text-align: left;
  }

  .review-list h3 {
    font-family: 'Noto Serif SC', serif;
    font-size: 1rem;
    margin-bottom: 16px;
    color: var(--ink);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .review-item {
    background: white;
    border-radius: 10px;
    border: 1px solid var(--paper-dark);
    padding: 20px 24px;
    margin-bottom: 12px;
  }

  .review-item .r-top {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
  }

  .review-item .r-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .r-dot.ok { background: var(--correct); }
  .r-dot.fail { background: var(--wrong); }
  .r-dot.skip { background: var(--gold); }

  .review-item .r-q {
    font-size: 0.88rem;
    color: var(--ink);
    line-height: 1.6;
    flex: 1;
  }

  .review-item .r-ans {
    font-size: 0.82rem;
    color: var(--ink-light);
    margin-top: 6px;
    padding-left: 20px;
    line-height: 1.7;
  }

  .result-actions {
    display: flex;
    gap: 14px;
    margin-top: 28px;
  }

  .result-actions .btn { flex: 1; padding: 14px; font-size: 0.95rem; letter-spacing: 2px; }

  /* â”€â”€â”€ ERROR â”€â”€â”€ */
  .error-box {
    background: rgba(192,57,43,0.08);
    border: 1px solid rgba(192,57,43,0.3);
    border-radius: var(--radius);
    padding: 20px 24px;
    color: var(--accent);
    margin-bottom: 20px;
    font-size: 0.9rem;
    line-height: 1.7;
  }

  /* â”€â”€â”€ ANIMATIONS â”€â”€â”€ */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: none; } }
  @keyframes spin { to { transform: rotate(360deg); } }

  .hidden { display: none !important; }

  /* Tooltip */
  .tooltip {
    font-size: 0.75rem;
    color: var(--ink-light);
    margin-top: 4px;
  }

  /* Manual entry */
  .manual-toggle {
    text-align: center;
    margin-top: 16px;
  }

  .manual-toggle a {
    color: var(--ink-light);
    font-size: 0.85rem;
    cursor: pointer;
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  .manual-area {
    margin-top: 16px;
  }

  .manual-area textarea {
    width: 100%;
    height: 200px;
    padding: 16px;
    border: 1.5px dashed var(--gold);
    border-radius: var(--radius);
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.85rem;
    line-height: 1.8;
    background: rgba(201,168,76,0.04);
    color: var(--ink);
    resize: vertical;
    outline: none;
  }

  .parse-manual-btn {
    margin-top: 10px;
    padding: 10px 24px;
    background: var(--ink);
    color: white;
    border: none;
    border-radius: 8px;
    font-family: 'Noto Sans SC', sans-serif;
    font-size: 0.88rem;
    cursor: pointer;
    transition: background 0.2s;
    letter-spacing: 1px;
  }

  .parse-manual-btn:hover { background: var(--accent); }
</style>
</head>
<body>
<div class="wrapper">

  <div class="header">
    <h1>è¯¾å ‚ç­”é¢˜</h1>
    <span class="sub">QUIZ SYSTEM</span>
  </div>

  <!-- â”€â”€â”€ UPLOAD â”€â”€â”€ -->
  <div id="upload-screen">
    <div class="upload-zone" id="drop-zone">
      <input type="file" id="file-input" accept=".docx">
      <span class="upload-icon">ğŸ“„</span>
      <h2>ä¸Šä¼ é¢˜åº“æ–‡ä»¶</h2>
      <p>æ”¯æŒ .docx Word æ–‡æ¡£<br>æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ </p>
    </div>

    <div class="manual-toggle">
      <a id="show-manual">æˆ–è€…ç›´æ¥ç²˜è´´æ–‡å­—é¢˜ç›®</a>
    </div>
    <div class="manual-area hidden" id="manual-area">
      <textarea id="manual-text" placeholder="åœ¨æ­¤ç²˜è´´ä½ çš„é¢˜ç›®æ–‡å­—â€¦â€¦"></textarea>
      <br>
      <button class="parse-manual-btn" id="parse-manual-btn">è§£æé¢˜ç›®</button>
    </div>

    <div class="format-guide">
      <h3>ğŸ“‹ é¢˜åº“æ ¼å¼è¯´æ˜</h3>
      <div class="format-tabs">
        <div class="format-tab active" data-tab="single">å•é€‰é¢˜</div>
        <div class="format-tab" data-tab="multi">å¤šé€‰é¢˜</div>
        <div class="format-tab" data-tab="judge">åˆ¤æ–­é¢˜</div>
        <div class="format-tab" data-tab="fill">å¡«ç©ºé¢˜</div>
        <div class="format-tab" data-tab="short">ç®€ç­”é¢˜</div>
      </div>
      <div id="fmt-single" class="fmt-content">
<pre>1. ä»¥ä¸‹å“ªä¸ªé€‰é¡¹æ˜¯æ­£ç¡®çš„ï¼Ÿã€å•é€‰ã€‘
A. é€‰é¡¹ä¸€
B. é€‰é¡¹äºŒ
C. é€‰é¡¹ä¸‰
D. é€‰é¡¹å››
ç­”æ¡ˆï¼šB
è§£æï¼šå› ä¸ºâ€¦â€¦ï¼ˆå¯é€‰ï¼‰</pre>
      </div>
      <div id="fmt-multi" class="fmt-content hidden">
<pre>2. ä»¥ä¸‹å“ªäº›å±äºæ­£ç¡®ç­”æ¡ˆï¼Ÿã€å¤šé€‰ã€‘
A. é€‰é¡¹ä¸€
B. é€‰é¡¹äºŒ
C. é€‰é¡¹ä¸‰
D. é€‰é¡¹å››
ç­”æ¡ˆï¼šABD
è§£æï¼šAã€Bã€D å‡ç¬¦åˆâ€¦â€¦ï¼ˆå¯é€‰ï¼‰</pre>
      </div>
      <div id="fmt-judge" class="fmt-content hidden">
<pre>3. è¿™é“é¢˜çš„è¯´æ³•æ˜¯æ­£ç¡®çš„ã€‚ã€åˆ¤æ–­ã€‘
ç­”æ¡ˆï¼šå¯¹
è§£æï¼šå› ä¸ºâ€¦â€¦ï¼ˆå¯é€‰ï¼‰</pre>
      </div>
      <div id="fmt-fill" class="fmt-content hidden">
<pre>4. ä¸­å›½çš„é¦–éƒ½æ˜¯____ã€‚ã€å¡«ç©ºã€‘
ç­”æ¡ˆï¼šåŒ—äº¬
è§£æï¼šåŒ—äº¬æ˜¯ä¸­åäººæ°‘å…±å’Œå›½çš„é¦–éƒ½ã€‚ï¼ˆå¯é€‰ï¼‰</pre>
      </div>
      <div id="fmt-short" class="fmt-content hidden">
<pre>5. ç®€è¿°â€¦â€¦çš„ä¸»è¦åŸå› ã€‚ã€ç®€ç­”ã€‘
ç­”æ¡ˆï¼šä¸»è¦åŸå› åŒ…æ‹¬â€¦â€¦
è§£æï¼šå‚è€ƒè¦ç‚¹â€¦â€¦ï¼ˆå¯é€‰ï¼‰</pre>
      </div>
    </div>
  </div>

  <!-- â”€â”€â”€ PARSING â”€â”€â”€ -->
  <div id="parse-screen" class="hidden">
    <div class="spinner"></div>
    <p style="color:var(--ink-light); font-size:0.9rem;">æ­£åœ¨è§£æé¢˜åº“â€¦â€¦</p>
  </div>

  <!-- â”€â”€â”€ SETUP â”€â”€â”€ -->
  <div id="setup-screen" class="hidden">
    <div class="parsed-info" id="parsed-info">
      <span class="icon">âœ…</span>
      <div>
        <strong id="parsed-title">é¢˜åº“åŠ è½½æˆåŠŸ</strong>
        <span id="parsed-detail"></span>
      </div>
    </div>
    <div id="setup-error" class="error-box hidden"></div>
    <div class="setup-form">
      <h2>è€ƒè¯•è®¾ç½®</h2>
      <div class="form-row">
        <div class="form-group">
          <label>é¢˜ç›®æ•°é‡</label>
          <input type="number" id="q-count" min="1" max="200" value="10">
        </div>
        <div class="form-group">
          <label>é¡ºåº</label>
          <select id="q-order">
            <option value="random">éšæœºå‡ºé¢˜</option>
            <option value="sequential">æŒ‰é¡ºåº</option>
          </select>
        </div>
      </div>
      <div class="form-group" style="margin-bottom:20px">
        <label>é¢˜ç›®ç±»å‹ç­›é€‰ï¼ˆä¸é€‰åˆ™å…¨éƒ¨ç±»å‹ï¼‰</label>
        <div class="type-toggles" id="type-toggles">
          <label class="type-toggle checked" data-type="single">
            <input type="checkbox" value="single" checked> å•é€‰é¢˜
          </label>
          <label class="type-toggle checked" data-type="multi">
            <input type="checkbox" value="multi" checked> å¤šé€‰é¢˜
          </label>
          <label class="type-toggle checked" data-type="judge">
            <input type="checkbox" value="judge" checked> åˆ¤æ–­é¢˜
          </label>
          <label class="type-toggle checked" data-type="fill">
            <input type="checkbox" value="fill" checked> å¡«ç©ºé¢˜
          </label>
          <label class="type-toggle checked" data-type="short">
            <input type="checkbox" value="short" checked> ç®€ç­”é¢˜
          </label>
        </div>
      </div>
      <button class="btn-start" id="btn-start">å¼€å§‹ç­”é¢˜</button>
    </div>
  </div>

  <!-- â”€â”€â”€ QUIZ â”€â”€â”€ -->
  <div id="quiz-screen" class="hidden">
    <div class="quiz-header">
      <span class="q-counter" id="q-counter">ç¬¬ 1 é¢˜ / å…± 10 é¢˜</span>
      <div class="progress-bar-wrap">
        <div class="progress-bar" id="progress-bar" style="width:0%"></div>
      </div>
      <span class="score-badge" id="score-badge">âœ“ 0</span>
    </div>

    <div class="q-card" id="q-card">
      <!-- dynamically rendered -->
    </div>
    <div id="result-box-wrap"></div>
    <div class="q-actions" id="q-actions">
      <button class="btn btn-skip" id="btn-skip">è·³è¿‡</button>
      <button class="btn btn-primary" id="btn-submit" disabled>æäº¤ç­”æ¡ˆ</button>
    </div>
    <div class="q-actions hidden" id="q-actions-next">
      <button class="btn btn-secondary" id="btn-quit">é€€å‡º</button>
      <button class="btn btn-primary" id="btn-next">ä¸‹ä¸€é¢˜ â†’</button>
    </div>
  </div>

  <!-- â”€â”€â”€ RESULTS â”€â”€â”€ -->
  <div id="result-screen" class="hidden">
    <div class="result-hero">
      <div class="result-grade" id="final-grade">85</div>
      <div id="final-msg" style="font-size:1.1rem; color:var(--ink-light);"></div>
      <div class="result-stats">
        <div class="stat">
          <div class="stat-num" id="stat-correct" style="color:var(--correct)">0</div>
          <div class="stat-label">ç­”å¯¹</div>
        </div>
        <div class="stat">
          <div class="stat-num" id="stat-wrong" style="color:var(--wrong)">0</div>
          <div class="stat-label">ç­”é”™</div>
        </div>
        <div class="stat">
          <div class="stat-num" id="stat-skip" style="color:var(--gold)">0</div>
          <div class="stat-label">è·³è¿‡</div>
        </div>
      </div>
    </div>

    <div class="review-list">
      <h3>ğŸ“‹ ç­”é¢˜å›é¡¾</h3>
      <div id="review-items"></div>
    </div>

    <div class="result-actions">
      <button class="btn btn-secondary" id="btn-reuse">æ¢é¢˜å†è€ƒ</button>
      <button class="btn btn-primary" id="btn-new">é‡æ–°ä¸Šä¼ é¢˜åº“</button>
    </div>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allQuestions = [];
let quizQuestions = [];
let currentIdx = 0;
let currentAnswer = null;
let results = [];
let correctCount = 0;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SCREEN SWITCHING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const screens = ['upload-screen','parse-screen','setup-screen','quiz-screen','result-screen'];

function show(id) {
  screens.forEach(s => {
    document.getElementById(s).classList.toggle('hidden', s !== id);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMAT TABS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.format-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.format-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.fmt-content').forEach(c => c.classList.add('hidden'));
    tab.classList.add('active');
    document.getElementById('fmt-' + tab.dataset.tab).classList.remove('hidden');
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILE UPLOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) processFile(fileInput.files[0]);
});

async function processFile(file) {
  if (!file.name.endsWith('.docx')) {
    alert('è¯·ä¸Šä¼  .docx æ ¼å¼çš„ Word æ–‡æ¡£');
    return;
  }
  show('parse-screen');
  try {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    const text = result.value;
    parseAndSetup(text, file.name);
  } catch(e) {
    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼\n' + e.message);
    show('upload-screen');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MANUAL TEXT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('show-manual').addEventListener('click', () => {
  document.getElementById('manual-area').classList.toggle('hidden');
});

document.getElementById('parse-manual-btn').addEventListener('click', () => {
  const text = document.getElementById('manual-text').value.trim();
  if (!text) { alert('è¯·å…ˆç²˜è´´é¢˜ç›®æ–‡å­—'); return; }
  show('parse-screen');
  setTimeout(() => parseAndSetup(text, 'æ‰‹åŠ¨è¾“å…¥'), 200);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PARSER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseAndSetup(text, filename) {
  const questions = parseQuestions(text);
  if (questions.length === 0) {
    allQuestions = [];
    show('setup-screen');
    document.getElementById('parsed-info').style.display = 'none';
    const errEl = document.getElementById('setup-error');
    errEl.classList.remove('hidden');
    errEl.innerHTML = 'âš ï¸ æœªèƒ½ä»æ–‡ä»¶ä¸­è¯†åˆ«å‡ºé¢˜ç›®ã€‚è¯·ç¡®è®¤æ ¼å¼ç¬¦åˆè¯´æ˜ï¼Œæˆ–æ£€æŸ¥é¢˜ç›®æ˜¯å¦åŒ…å« <strong>ç­”æ¡ˆï¼š</strong> å­—æ ·ã€‚';
    document.getElementById('btn-start').disabled = true;
    return;
  }

  allQuestions = questions;
  show('setup-screen');

  document.getElementById('setup-error').classList.add('hidden');
  document.getElementById('parsed-info').style.display = 'flex';
  document.getElementById('parsed-title').textContent = filename.replace('.docx','');

  const typeCounts = {};
  questions.forEach(q => { typeCounts[q.type] = (typeCounts[q.type]||0)+1; });
  const typeNames = { single:'å•é€‰', multi:'å¤šé€‰', judge:'åˆ¤æ–­', fill:'å¡«ç©º', short:'ç®€ç­”' };
  const detail = Object.entries(typeCounts).map(([t,n]) => `${typeNames[t]||t}${n}é“`).join(' Â· ');
  document.getElementById('parsed-detail').textContent = `å…± ${questions.length} é“é¢˜ Â· ${detail}`;

  const qCountEl = document.getElementById('q-count');
  qCountEl.max = questions.length;
  qCountEl.value = Math.min(10, questions.length);
  document.getElementById('btn-start').disabled = false;

  // show/hide type toggles based on available types
  document.querySelectorAll('.type-toggle').forEach(toggle => {
    const type = toggle.dataset.type;
    toggle.style.opacity = typeCounts[type] ? '1' : '0.35';
  });
}

function parseQuestions(text) {
  // Normalize: trim lines, collapse blank lines
  const lines = text.split('\n').map(l => l.trim());
  const questions = [];

  // We'll build a raw "blocks" by splitting on question number patterns
  // Pattern: line starting with number followed by . or ã€or ï¼‰
  const qStartRe = /^(\d+)[.ã€ï¼ã€‚ï¼‰)]\s*/;

  let blocks = [];
  let currentBlock = null;

  for (let line of lines) {
    if (!line) continue;
    const m = line.match(qStartRe);
    if (m) {
      if (currentBlock) blocks.push(currentBlock);
      currentBlock = { num: parseInt(m[1]), lines: [line.replace(qStartRe, '').trim()] };
    } else if (currentBlock) {
      currentBlock.lines.push(line);
    }
  }
  if (currentBlock) blocks.push(currentBlock);

  for (let block of blocks) {
    const q = parseBlock(block);
    if (q) questions.push(q);
  }

  return questions;
}

function parseBlock(block) {
  const allLines = block.lines.filter(l => l.length > 0);
  if (!allLines.length) return null;

  // Find answer line
  const answerIdx = allLines.findIndex(l => /^ç­”æ¡ˆ[ï¼š:]/i.test(l));
  const explainIdx = allLines.findIndex(l => /^è§£æ[ï¼š:]/i.test(l));

  const answerLine = answerIdx >= 0 ? allLines[answerIdx] : null;
  const answerText = answerLine ? answerLine.replace(/^ç­”æ¡ˆ[ï¼š:]\s*/i, '').trim() : '';
  const explanationLines = [];
  if (explainIdx >= 0) {
    explanationLines.push(allLines[explainIdx].replace(/^è§£æ[ï¼š:]\s*/i, '').trim());
    for (let i = explainIdx + 1; i < allLines.length; i++) {
      if (/^ç­”æ¡ˆ[ï¼š:]/.test(allLines[i])) break;
      explanationLines.push(allLines[i]);
    }
  }
  const explanation = explanationLines.join(' ').trim();

  // Content lines (before answer/explain)
  const limit = Math.min(
    answerIdx >= 0 ? answerIdx : 9999,
    explainIdx >= 0 ? explainIdx : 9999
  );
  const contentLines = allLines.slice(0, limit);

  if (!contentLines.length) return null;

  // Detect type from tag in question text
  const fullContent = contentLines.join(' ');
  let detectedType = null;
  if (/ã€å•é€‰ã€‘|ï¼ˆå•é€‰ï¼‰|\(å•é€‰\)/.test(fullContent)) detectedType = 'single';
  else if (/ã€å¤šé€‰ã€‘|ï¼ˆå¤šé€‰ï¼‰|\(å¤šé€‰\)/.test(fullContent)) detectedType = 'multi';
  else if (/ã€åˆ¤æ–­ã€‘|ï¼ˆåˆ¤æ–­ï¼‰|\(åˆ¤æ–­\)/.test(fullContent)) detectedType = 'judge';
  else if (/ã€å¡«ç©ºã€‘|ï¼ˆå¡«ç©ºï¼‰|\(å¡«ç©º\)/.test(fullContent)) detectedType = 'fill';
  else if (/ã€ç®€ç­”ã€‘|ï¼ˆç®€ç­”ï¼‰|\(ç®€ç­”\)|ã€é—®ç­”ã€‘/.test(fullContent)) detectedType = 'short';

  // Options: lines starting with A/B/C/D etc.
  const optionRe = /^([A-Ja-j])[.ã€ï¼ã€‚ï¼‰)]\s*(.*)/;
  const options = [];
  const questionTextLines = [];

  for (let line of contentLines) {
    const om = line.match(optionRe);
    if (om) {
      options.push({ letter: om[1].toUpperCase(), text: om[2].trim() });
    } else {
      // Remove type tag from question text
      const cleaned = line.replace(/ã€å•é€‰ã€‘|ã€å¤šé€‰ã€‘|ã€åˆ¤æ–­ã€‘|ã€å¡«ç©ºã€‘|ã€ç®€ç­”ã€‘|ã€é—®ç­”ã€‘|ï¼ˆå•é€‰ï¼‰|ï¼ˆå¤šé€‰ï¼‰|ï¼ˆåˆ¤æ–­ï¼‰|ï¼ˆå¡«ç©ºï¼‰|ï¼ˆç®€ç­”ï¼‰|\(å•é€‰\)|\(å¤šé€‰\)|\(åˆ¤æ–­\)|\(å¡«ç©º\)|\(ç®€ç­”\)/g, '').trim();
      if (cleaned) questionTextLines.push(cleaned);
    }
  }

  const questionText = questionTextLines.join(' ').trim();
  if (!questionText) return null;

  // Auto-detect type if not tagged
  if (!detectedType) {
    if (options.length >= 2) {
      // Check answer: if multiple letters, multi; else single
      const ansNorm = answerText.replace(/[,ï¼Œ\s]/g,'').toUpperCase();
      if (ansNorm.length > 1 && /^[A-J]+$/.test(ansNorm)) detectedType = 'multi';
      else detectedType = 'single';
    } else {
      // Judge if answer is å¯¹/é”™/æ­£ç¡®/é”™è¯¯/TRUE/FALSE/âˆš/Ã—/æ˜¯/å¦
      if (/^(å¯¹|é”™|æ­£ç¡®|é”™è¯¯|true|false|âˆš|Ã—|æ˜¯|å¦)$/i.test(answerText)) {
        detectedType = 'judge';
      } else if (questionText.includes('____') || questionText.includes('___')) {
        detectedType = 'fill';
      } else {
        detectedType = 'short';
      }
    }
  }

  return {
    id: block.num,
    type: detectedType,
    text: questionText,
    options,
    answer: answerText,
    explanation
  };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  TYPE TOGGLES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.type-toggle').forEach(toggle => {
  toggle.addEventListener('click', () => {
    toggle.classList.toggle('checked');
    const cb = toggle.querySelector('input');
    cb.checked = toggle.classList.contains('checked');
  });
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  START QUIZ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-start').addEventListener('click', () => {
  const selectedTypes = [...document.querySelectorAll('.type-toggle.checked input')].map(cb => cb.value);
  if (!selectedTypes.length) { alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜ç›®ç±»å‹'); return; }

  let pool = allQuestions.filter(q => selectedTypes.includes(q.type));
  if (!pool.length) { alert('æ‰€é€‰ç±»å‹ä¸­æ²¡æœ‰é¢˜ç›®ï¼Œè¯·é‡æ–°é€‰æ‹©'); return; }

  const order = document.getElementById('q-order').value;
  if (order === 'random') pool = shuffle(pool);

  const count = Math.min(parseInt(document.getElementById('q-count').value) || 10, pool.length);
  quizQuestions = pool.slice(0, count);
  currentIdx = 0;
  results = [];
  correctCount = 0;

  show('quiz-screen');
  renderQuestion();
});

function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER QUESTION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuestion() {
  const q = quizQuestions[currentIdx];
  currentAnswer = null;

  // Update header
  document.getElementById('q-counter').textContent = `ç¬¬ ${currentIdx+1} é¢˜ / å…± ${quizQuestions.length} é¢˜`;
  document.getElementById('progress-bar').style.width = `${(currentIdx / quizQuestions.length) * 100}%`;
  document.getElementById('score-badge').textContent = `âœ“ ${correctCount}`;

  // Clear result
  document.getElementById('result-box-wrap').innerHTML = '';

  // Show submit/skip, hide next
  document.getElementById('q-actions').classList.remove('hidden');
  document.getElementById('q-actions-next').classList.add('hidden');
  document.getElementById('btn-submit').disabled = true;
  document.getElementById('btn-next').textContent = currentIdx < quizQuestions.length - 1 ? 'ä¸‹ä¸€é¢˜ â†’' : 'æŸ¥çœ‹æˆç»©';

  // Render card
  const card = document.getElementById('q-card');
  const typeNames = { single:'å•é€‰é¢˜', multi:'å¤šé€‰é¢˜', judge:'åˆ¤æ–­é¢˜', fill:'å¡«ç©ºé¢˜', short:'ç®€ç­”é¢˜' };
  const tagClass = `tag-${q.type}`;

  let bodyHTML = '';

  if (q.type === 'single' || q.type === 'multi') {
    const shuffledOpts = q.type === 'single' ? q.options : [...q.options]; // keep multi order
    bodyHTML = `<div class="options" id="options-wrap">` +
      shuffledOpts.map(opt => `
        <div class="option" data-letter="${opt.letter}" onclick="selectOption(this,'${q.type}')">
          <div class="opt-letter">${opt.letter}</div>
          <div class="opt-text">${escHtml(opt.text)}</div>
        </div>
      `).join('') +
    `</div>`;
    if (q.type === 'multi') {
      bodyHTML += `<p class="tooltip" style="margin-top:12px">å¤šé€‰é¢˜å¯é€‰æ‹©å¤šä¸ªç­”æ¡ˆ</p>`;
    }
  } else if (q.type === 'judge') {
    bodyHTML = `<div class="judge-options">
      <button class="judge-btn" data-val="å¯¹" onclick="selectJudge(this)">
        âœ… <span>æ­£ç¡® / å¯¹</span>
      </button>
      <button class="judge-btn" data-val="é”™" onclick="selectJudge(this)">
        âŒ <span>é”™è¯¯ / é”™</span>
      </button>
    </div>`;
  } else {
    bodyHTML = `<textarea class="answer-input" id="text-answer" rows="${q.type==='short'?5:2}"
      placeholder="${q.type==='fill' ? 'è¯·è¾“å…¥ç­”æ¡ˆâ€¦' : 'è¯·ç®€è¦ä½œç­”â€¦'}"
      oninput="onTextInput()"></textarea>`;
  }

  card.innerHTML = `
    <div class="q-type-tag ${tagClass}">${typeNames[q.type] || q.type}</div>
    <div class="q-text"><span class="q-num">${currentIdx+1}.</span>${escHtml(q.text)}</div>
    ${bodyHTML}
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INTERACTION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selectOption(el, type) {
  if (el.classList.contains('disabled')) return;
  if (type === 'single') {
    document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
    currentAnswer = el.dataset.letter;
  } else {
    el.classList.toggle('selected');
    const selected = [...document.querySelectorAll('.option.selected')].map(o => o.dataset.letter).sort().join('');
    currentAnswer = selected || null;
  }
  document.getElementById('btn-submit').disabled = !currentAnswer;
}

function selectJudge(el) {
  if (el.classList.contains('disabled')) return;
  document.querySelectorAll('.judge-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  currentAnswer = el.dataset.val;
  document.getElementById('btn-submit').disabled = false;
}

function onTextInput() {
  const val = document.getElementById('text-answer').value.trim();
  currentAnswer = val || null;
  document.getElementById('btn-submit').disabled = !val;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SUBMIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-submit').addEventListener('click', () => submitAnswer(false));
document.getElementById('btn-skip').addEventListener('click', () => skipQuestion());

function submitAnswer(skipped) {
  const q = quizQuestions[currentIdx];
  const userAns = skipped ? null : currentAnswer;
  const isCorrect = !skipped && checkAnswer(q, userAns);

  if (isCorrect) correctCount++;

  results.push({ q, userAns, isCorrect, skipped });

  // Disable inputs
  document.querySelectorAll('.option, .judge-btn').forEach(el => el.classList.add('disabled'));
  const textEl = document.getElementById('text-answer');
  if (textEl) textEl.disabled = true;

  // Show result
  showResult(q, userAns, isCorrect, skipped);

  // Switch buttons
  document.getElementById('q-actions').classList.add('hidden');
  document.getElementById('q-actions-next').classList.remove('hidden');
  document.getElementById('btn-next').textContent = currentIdx < quizQuestions.length - 1 ? 'ä¸‹ä¸€é¢˜ â†’' : 'æŸ¥çœ‹æˆç»©';
}

function skipQuestion() {
  submitAnswer(true);
}

function checkAnswer(q, userAns) {
  if (!userAns) return false;
  const correct = q.answer.trim().toUpperCase().replace(/[,ï¼Œ\s]/g,'');
  const user = userAns.toUpperCase().replace(/[,ï¼Œ\s]/g,'');

  if (q.type === 'single' || q.type === 'multi') {
    return user === correct;
  } else if (q.type === 'judge') {
    const normalizeJudge = v => {
      const pos = /^(å¯¹|æ­£ç¡®|true|âˆš|æ˜¯|t|y|yes|1)$/i;
      const neg = /^(é”™|é”™è¯¯|false|Ã—|å¦|f|n|no|0)$/i;
      if (pos.test(v)) return 'T';
      if (neg.test(v)) return 'F';
      return v;
    };
    return normalizeJudge(user) === normalizeJudge(correct);
  } else {
    // Fill/short: fuzzy â€” check if user answer contains key answer words
    const ansWords = correct.split(/[ï¼Œ,ã€\s]+/).filter(Boolean);
    return ansWords.every(w => user.includes(w.toUpperCase()));
  }
}

function showResult(q, userAns, isCorrect, skipped) {
  const wrap = document.getElementById('result-box-wrap');

  // Mark correct/wrong options visually
  if (q.type === 'single' || q.type === 'multi') {
    const correctLetters = q.answer.toUpperCase().replace(/[,ï¼Œ\s]/g,'').split('');
    document.querySelectorAll('.option').forEach(opt => {
      const letter = opt.dataset.letter;
      if (correctLetters.includes(letter)) {
        opt.classList.add('correct-ans');
      } else if (opt.classList.contains('selected')) {
        opt.classList.add('wrong-ans');
        opt.classList.remove('selected');
      }
    });
  } else if (q.type === 'judge') {
    const correct = q.answer.trim();
    document.querySelectorAll('.judge-btn').forEach(btn => {
      if (normalizeJudgeMatch(btn.dataset.val, correct)) {
        btn.classList.add('correct-ans');
      } else if (btn.classList.contains('selected')) {
        btn.classList.add('wrong-ans');
        btn.classList.remove('selected');
      }
    });
  }

  let verb = skipped ? 'å·²è·³è¿‡' : isCorrect ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯';
  let icon = skipped ? 'â­ï¸' : isCorrect ? 'âœ…' : 'âŒ';
  let cls = isCorrect ? 'correct' : 'wrong';

  const userDisplay = skipped ? 'ï¼ˆå·²è·³è¿‡ï¼‰' : (userAns || 'ï¼ˆæœªä½œç­”ï¼‰');

  wrap.innerHTML = `
    <div class="result-box ${cls}" style="margin-top:16px">
      <div class="result-verdict"><span class="v-icon">${icon}</span>${verb}</div>
      <div class="result-answer">
        ${!skipped ? `<span>ä½ çš„ç­”æ¡ˆï¼š${escHtml(userDisplay)}</span><br>` : ''}
        <strong style="margin-top:8px">æ­£ç¡®ç­”æ¡ˆï¼š${escHtml(q.answer)}</strong>
      </div>
      ${q.explanation ? `<div class="result-explanation"><strong>ğŸ“– è§£æ</strong>${escHtml(q.explanation)}</div>` : ''}
    </div>
  `;
}

function normalizeJudgeMatch(v, correct) {
  const pos = s => /^(å¯¹|æ­£ç¡®|true|âˆš|æ˜¯)$/i.test(s);
  const neg = s => /^(é”™|é”™è¯¯|false|Ã—|å¦)$/i.test(s);
  if (pos(v) && pos(correct)) return true;
  if (neg(v) && neg(correct)) return true;
  return false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  NEXT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-next').addEventListener('click', () => {
  currentIdx++;
  if (currentIdx >= quizQuestions.length) {
    showFinalResults();
  } else {
    renderQuestion();
  }
});

document.getElementById('btn-quit').addEventListener('click', () => {
  if (confirm('ç¡®å®šè¦é€€å‡ºæœ¬æ¬¡ç­”é¢˜å—ï¼Ÿ')) showFinalResults();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FINAL RESULTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showFinalResults() {
  show('result-screen');

  const done = results.filter(r => !r.skipped).length;
  const correct = results.filter(r => r.isCorrect).length;
  const wrong = results.filter(r => !r.isCorrect && !r.skipped).length;
  const skipped = results.filter(r => r.skipped).length;
  const score = done > 0 ? Math.round((correct / quizQuestions.length) * 100) : 0;

  document.getElementById('stat-correct').textContent = correct;
  document.getElementById('stat-wrong').textContent = wrong;
  document.getElementById('stat-skip').textContent = skipped;

  const gradeEl = document.getElementById('final-grade');
  gradeEl.textContent = score + 'åˆ†';
  gradeEl.className = 'result-grade' + (score >= 60 ? ' pass' : '');

  const msgs = [
    [90, 'ä¼˜ç§€ï¼è¡¨ç°å‡ºè‰² ğŸ‰'],
    [75, 'è‰¯å¥½ï¼ç»§ç»­åŠ æ²¹ ğŸ‘'],
    [60, 'åŠæ ¼ï¼Œè¿˜éœ€åŠªåŠ› ğŸ“š'],
    [0,  'ä¸åŠæ ¼ï¼Œè¯·å¤šå¤ä¹  ğŸ’ª']
  ];
  document.getElementById('final-msg').textContent = msgs.find(([min]) => score >= min)[1];

  // Review
  const reviewEl = document.getElementById('review-items');
  reviewEl.innerHTML = results.map((r, i) => {
    const status = r.skipped ? 'skip' : r.isCorrect ? 'ok' : 'fail';
    const statusText = r.skipped ? 'è·³è¿‡' : r.isCorrect ? 'æ­£ç¡®' : 'é”™è¯¯';
    return `
      <div class="review-item">
        <div class="r-top">
          <div class="r-dot ${status}"></div>
          <div class="r-q">${i+1}. ${escHtml(r.q.text.slice(0,60))}${r.q.text.length>60?'â€¦':''}</div>
          <span style="font-size:0.78rem;color:var(--ink-light)">${statusText}</span>
        </div>
        <div class="r-ans">
          ${!r.skipped && r.userAns ? `ä½ ï¼š${escHtml(r.userAns)} &nbsp;|&nbsp; ` : ''}
          æ­£ç¡®ï¼š${escHtml(r.q.answer)}
        </div>
      </div>
    `;
  }).join('');

  // Progress bar final
  document.getElementById('progress-bar').style.width = '100%';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RESET
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-reuse').addEventListener('click', () => {
  show('setup-screen');
});

document.getElementById('btn-new').addEventListener('click', () => {
  allQuestions = [];
  quizQuestions = [];
  document.getElementById('file-input').value = '';
  document.getElementById('manual-text').value = '';
  document.getElementById('manual-area').classList.add('hidden');
  show('upload-screen');
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  UTILS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
